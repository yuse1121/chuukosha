import streamlit as st
import pandas as pd
import joblib
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns 
import matplotlib.font_manager as fm
import shap 
import re # â˜… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºã®ãŸã‚ã«æ­£è¦è¡¨ç¾ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# ========== ãƒ‡ãƒ¼ã‚¿å®šç¾© (ã‚°ãƒ­ãƒ¼ãƒãƒ«) ==========
# (COUNTRIES_DATA, recommendation_data, etc... ã¯å¤‰æ›´ãªã—)

# 1. â˜… å›½ãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»è»Šç¨®ã®éšå±¤ãƒ‡ãƒ¼ã‚¿ (train_model.py ã¨åŒã˜ã‚‚ã®) â˜…
COUNTRIES_DATA = {
    'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': {
        'ãƒˆãƒ¨ã‚¿': ['ã‚«ãƒ­ãƒ¼ãƒ©', 'ãƒ—ãƒªã‚¦ã‚¹', 'ãƒ¤ãƒªã‚¹', 'RAV4', 'ã‚·ã‚¨ãƒ³ã‚¿', 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ¼ãƒ‰', 'ãƒ´ã‚©ã‚¯ã‚·ãƒ¼', 'ãƒã‚¢', 'ãƒãƒªã‚¢ãƒ¼', 'ãƒ©ãƒ³ãƒ‰ã‚¯ãƒ«ãƒ¼ã‚¶ãƒ¼', 'ã‚¢ã‚¯ã‚¢', 'ãƒ«ãƒ¼ãƒŸãƒ¼', 'C-HR', 'ã‚¯ãƒ©ã‚¦ãƒ³', 'ãƒã‚¤ã‚¨ãƒ¼ã‚¹', 'ã‚«ãƒ ãƒª', 'ãƒ©ã‚¤ã‚º', '86', 'ã‚¹ãƒ¼ãƒ—ãƒ©', 'MIRAI', 'ãƒ‘ãƒƒã‚½', 'ãƒ´ã‚£ãƒƒãƒ„(æ—§)', 'ãƒãƒ¼ã‚¯X(æ—§)', 'ã‚¨ã‚¹ãƒ†ã‚£ãƒ(æ—§)', 'ã‚¦ã‚£ãƒƒã‚·ãƒ¥(æ—§)', 'bB(æ—§)', 'FJã‚¯ãƒ«ãƒ¼ã‚¶ãƒ¼(æ—§)', 'ã‚¹ãƒšã‚¤ãƒ‰', 'ãƒãƒ«ãƒ†', 'ã‚»ãƒ³ãƒãƒ¥ãƒªãƒ¼'],
        'ãƒ¬ã‚¯ã‚µã‚¹': ['LS', 'RX', 'NX', 'UX', 'IS', 'ES', 'LC', 'LX', 'GX', 'RC', 'CT'],
        'æ—¥ç”£': ['ãƒãƒ¼ãƒˆ', 'ã‚»ãƒ¬ãƒŠ', 'ã‚¨ã‚¯ã‚¹ãƒˆãƒ¬ã‚¤ãƒ«', 'ãƒªãƒ¼ãƒ•', 'ã‚µã‚¯ãƒ©', 'ãƒ«ãƒ¼ã‚¯ã‚¹', 'ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³', 'GT-R', 'ãƒ•ã‚§ã‚¢ãƒ¬ãƒ‡ã‚£Z', 'ã‚­ãƒƒã‚¯ã‚¹', 'ã‚¢ãƒªã‚¢', 'ãƒ‡ã‚¤ã‚º', 'NV350ã‚­ãƒ£ãƒ©ãƒãƒ³', 'ã‚¨ãƒ«ã‚°ãƒ©ãƒ³ãƒ‰', 'NV200ãƒãƒãƒƒãƒˆ', 'ãƒãƒ¼ãƒ', 'ã‚¸ãƒ¥ãƒ¼ã‚¯', 'ãƒ†ã‚£ã‚¢ãƒŠ', 'ã‚¦ã‚¤ãƒ³ã‚°ãƒ­ãƒ¼ãƒ‰', 'ã‚­ãƒ¥ãƒ¼ãƒ–', 'ãƒ•ãƒ¼ã‚¬', 'ã‚·ãƒ¼ãƒ', 'ã‚·ãƒ«ãƒ“ã‚¢(æ—§)', '180SX(æ—§)', 'ãƒ©ãƒ•ã‚§ã‚¹ã‚¿(æ—§)', 'ãƒ‡ãƒ¥ã‚¢ãƒªã‚¹(æ—§)', 'ãƒ ãƒ©ãƒ¼ãƒ(æ—§)', 'ã‚¯ãƒªãƒƒãƒ‘ãƒ¼', 'ãƒ¢ã‚³(æ—§)', 'ã‚ªãƒƒãƒ†ã‚£(æ—§)'],
        'ãƒ›ãƒ³ãƒ€': ['ãƒ•ã‚£ãƒƒãƒˆ', 'ãƒ´ã‚§ã‚¼ãƒ«', 'N-BOX', 'ã‚·ãƒ“ãƒƒã‚¯', 'ã‚¹ãƒ†ãƒƒãƒ—ãƒ¯ã‚´ãƒ³', 'ãƒ•ãƒªãƒ¼ãƒ‰', 'ZR-V', 'ã‚ªãƒ‡ãƒƒã‚»ã‚¤', 'ã‚¢ã‚³ãƒ¼ãƒ‰', 'CR-V', 'S660', 'NSX', 'N-WGN', 'N-ONE', 'N-VAN', 'ã‚¤ãƒ³ã‚µã‚¤ãƒˆ', 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', 'e', 'ã‚·ãƒ£ãƒˆãƒ«', 'ã‚°ãƒ¬ã‚¤ã‚¹', 'CR-Z(æ—§)', 'S2000(æ—§)', 'ã‚¨ãƒªã‚·ã‚ªãƒ³(æ—§)', 'ã‚¯ãƒ­ã‚¹ãƒ­ãƒ¼ãƒ‰(æ—§)', 'ãƒãƒ¢ã‚¹(æ—§)', 'ãƒ©ã‚¤ãƒ•(æ—§)', 'ã‚¼ã‚¹ãƒˆ(æ—§)', 'ãƒ¢ãƒ“ãƒªã‚ª(æ—§)', 'ã‚¸ã‚§ã‚¤ãƒ‰', 'ã‚¯ãƒ©ãƒªãƒ†ã‚£'],
        'ãƒãƒ„ãƒ€': ['CX-5', 'Mazda2', 'Mazda3', 'CX-30', 'CX-60', 'ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼', 'CX-3', 'CX-8', 'Mazda6', 'MX-30', 'ãƒ•ãƒ¬ã‚¢', 'ã‚­ãƒ£ãƒ­ãƒ«', 'ã‚¢ã‚¯ã‚»ãƒ©(æ—§)', 'ãƒ‡ãƒŸã‚ª(æ—§)', 'ã‚¢ãƒ†ãƒ³ã‚¶(æ—§)', 'MPV(æ—§)', 'ãƒ—ãƒ¬ãƒã‚·ãƒ¼(æ—§)', 'ãƒ™ãƒªãƒ¼ã‚µ(æ—§)', 'RX-8(æ—§)', 'ãƒ“ã‚¢ãƒ³ãƒ†(æ—§)', 'RX-7(æ—§)', 'AZ-1(æ—§)', 'ã‚¹ã‚¯ãƒ©ãƒ ', 'ãƒœãƒ³ã‚´', 'ã‚¿ã‚¤ã‚¿ãƒ³', 'ãƒ•ã‚¡ãƒŸãƒªã‚¢(æ—§)', 'ã‚«ãƒšãƒ©(æ—§)', 'ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆ(æ—§)', 'ãƒ©ãƒ”ãƒ¥ã‚¿(æ—§)', 'CX-7(æ—§)'],
        'ã‚¹ãƒãƒ«': ['ãƒ¬ãƒ´ã‚©ãƒ¼ã‚°', 'ãƒ•ã‚©ãƒ¬ã‚¹ã‚¿ãƒ¼', 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚µ', 'ã‚¯ãƒ­ã‚¹ãƒˆãƒ¬ãƒƒã‚¯', 'ãƒ¬ã‚¬ã‚·ã‚£ ã‚¢ã‚¦ãƒˆãƒãƒƒã‚¯', 'WRX S4', 'BRZ', 'ã‚¸ãƒ£ã‚¹ãƒ†ã‚£', 'ã‚µãƒ³ãƒãƒ¼', 'XV(æ—§)', 'ã‚¨ã‚¯ã‚·ãƒ¼ã‚¬(æ—§)', 'ãƒ‡ã‚£ã‚¢ã‚¹ãƒ¯ã‚´ãƒ³', 'ã‚¹ãƒ†ãƒ©', 'ãƒ—ãƒ¬ã‚ª', 'R1(æ—§)', 'R2(æ—§)', 'WRX STI(æ—§)', 'ãƒˆãƒ¬ã‚¸ã‚¢', 'ã‚¢ãƒ«ã‚·ã‚ªãƒ¼ãƒ(æ—§)', 'ãƒ´ã‚£ãƒ´ã‚£ã‚ª(æ—§)', 'ãƒ¬ãƒƒã‚¯ã‚¹(æ—§)', 'ãƒ¬ã‚¬ã‚·ã‚£B4', 'ãƒ¬ã‚¬ã‚·ã‚£ãƒ„ãƒ¼ãƒªãƒ³ã‚°ãƒ¯ã‚´ãƒ³(æ—§)', 'ãƒ‰ãƒŸãƒ³ã‚´(æ—§)', 'ã‚·ãƒ•ã‚©ãƒ³', 'ãƒ‡ãƒƒã‚¯ã‚¹(æ—§)', 'ãƒ«ã‚¯ãƒ©(æ—§)', 'ãƒ•ã‚©ãƒ¬ã‚¹ã‚¿ãƒ¼(æ—§ä¸–ä»£)'],
        'ä¸‰è±': ['ã‚¢ã‚¦ãƒˆãƒ©ãƒ³ãƒ€ãƒ¼', 'ãƒ‡ãƒªã‚«D:5', 'eKã‚¯ãƒ­ã‚¹', 'ã‚¨ã‚¯ãƒªãƒ—ã‚¹ã‚¯ãƒ­ã‚¹', 'RVR', 'eKãƒ¯ã‚´ãƒ³', 'ãƒ‡ãƒªã‚«D:2', 'ãƒ‘ã‚¸ã‚§ãƒ­(æ—§)', 'ãƒ‘ã‚¸ã‚§ãƒ­ãƒŸãƒ‹(æ—§)', 'ãƒ©ãƒ³ã‚µãƒ¼ã‚¨ãƒœãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³(æ—§)', 'i-MiEV', 'ãƒŸãƒ©ãƒ¼ã‚¸ãƒ¥', 'ã‚¿ã‚¦ãƒ³ãƒœãƒƒã‚¯ã‚¹', 'ãƒŸãƒ‹ã‚­ãƒ£ãƒ–', 'ã‚³ãƒ«ãƒˆ(æ—§)', 'ã‚®ãƒ£ãƒ©ãƒ³ãƒ•ã‚©ãƒ«ãƒ†ã‚£ã‚¹(æ—§)', 'ã‚¢ã‚¤(æ—§)', 'ãƒˆãƒƒãƒ', 'GTO(æ—§)', 'FTO(æ—§)', 'ã‚¨ã‚¯ãƒªãƒ—ã‚¹(æ—§)', 'ãƒ‡ã‚£ã‚¢ãƒãƒ³ãƒ†(æ—§)', 'ãƒ¬ã‚°ãƒŠãƒ (æ—§)', 'ã‚¨ã‚¢ãƒˆãƒ¬ãƒƒã‚¯(æ—§)', 'ã‚°ãƒ©ãƒ³ãƒ‡ã‚£ã‚¹(æ—§)', 'ãƒ‡ã‚£ã‚ªãƒ³(æ—§)', 'eKã‚¹ãƒãƒ¼ãƒ„(æ—§)', 'ãƒˆãƒ©ã‚¤ãƒˆãƒ³'],
        'ã‚¹ã‚ºã‚­': ['ã‚¸ãƒ ãƒ‹ãƒ¼', 'ãƒã‚¹ãƒ©ãƒ¼', 'ã‚¹ãƒšãƒ¼ã‚·ã‚¢', 'ãƒ¯ã‚´ãƒ³R', 'ã‚¹ã‚¤ãƒ•ãƒˆ', 'ã‚½ãƒªã‚ª', 'ã‚¢ãƒ«ãƒˆ', 'ãƒ©ãƒ‘ãƒ³', 'ã‚¨ãƒ–ãƒªã‚¤ãƒ¯ã‚´ãƒ³', 'ã‚¯ãƒ­ã‚¹ãƒ“ãƒ¼', 'ã‚¤ã‚°ãƒ‹ã‚¹', 'ã‚¨ã‚¹ã‚¯ãƒ¼ãƒ‰', 'ãƒãƒ¬ãƒ¼ãƒ', 'ãƒ©ãƒ³ãƒ‡ã‚£', 'SX4 S-CROSS', 'ã‚­ã‚¶ã‚·(æ—§)', 'Kei(æ—§)', 'ãƒ‘ãƒ¬ãƒƒãƒˆ(æ—§)', 'MRãƒ¯ã‚´ãƒ³(æ—§)', 'ã‚»ãƒ«ãƒœ(æ—§)', 'ã‚«ãƒ—ãƒãƒ¼ãƒ(æ—§)', 'ã‚¢ãƒ«ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹', 'ãƒ„ã‚¤ãƒ³(æ—§)', 'ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥(æ—§)', 'ã‚·ãƒœãƒ¬ãƒ¼(æ—§)', 'ã‚¨ãƒªã‚ª(æ—§)', 'X-90(æ—§)', 'ã‚­ãƒ£ãƒ©(æ—§)', 'ãƒ•ãƒ­ãƒ³ãƒ†(æ—§)', 'ãƒã‚¤ãƒ†ã‚£ãƒœãƒ¼ã‚¤(æ—§)'],
        'ãƒ€ã‚¤ãƒãƒ„': ['ã‚¿ãƒ³ãƒˆ', 'ãƒ ãƒ¼ãƒ´', 'ãƒ­ãƒƒã‚­ãƒ¼', 'ã‚¿ãƒ•ãƒˆ', 'ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹', 'ã‚¦ã‚§ã‚¤ã‚¯', 'ã‚³ãƒšãƒ³', 'ã‚¢ãƒˆãƒ¬ãƒ¼', 'ãƒã‚¤ã‚¼ãƒƒãƒˆã‚«ãƒ¼ã‚´', 'ãƒˆãƒ¼ãƒ«', 'ãƒ–ãƒ¼ãƒ³', 'ã‚­ãƒ£ã‚¹ãƒˆ', 'ãƒ ãƒ¼ãƒ´ã‚­ãƒ£ãƒ³ãƒã‚¹', 'ãƒŸãƒ©ãƒˆã‚³ãƒƒãƒˆ', 'ã‚¨ãƒƒã‚»(æ—§)', 'ã‚½ãƒ‹ã‚«(æ—§)', 'ãƒ†ãƒªã‚ªã‚¹ã‚­ãƒƒãƒ‰(æ—§)', 'MAX(æ—§)', 'ãƒã‚¤ã‚­ãƒƒãƒ‰(æ—§)', 'YRV(æ—§)', 'ãƒŸãƒ©(æ—§)', 'ãƒŸãƒ©ã‚¸ãƒ¼ãƒ(æ—§)', 'ãƒŸã‚¼ãƒƒãƒˆII(æ—§)', 'ã‚ªãƒ—ãƒ†ã‚£(æ—§)', 'ã‚¹ãƒˆãƒ¼ãƒªã‚¢(æ—§)', 'ã‚¯ãƒ¼(æ—§)', 'ãƒ“ãƒ¼ã‚´(æ—§)', 'ãƒ‡ãƒ«ã‚¿(æ—§)', 'ã‚·ãƒ£ãƒ¬ãƒ¼ãƒ‰(æ—§)', 'ã‚³ãƒ³ãƒ‘ãƒ¼ãƒ(æ—§)'],
        'ã„ã™ã‚': ['ï¼ˆãã®ä»–ï¼‰'],
        'æ—¥é‡': ['ï¼ˆãã®ä»–ï¼‰'],
        'UDãƒˆãƒ©ãƒƒã‚¯ã‚¹': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„': {
        'BMW': ['1ã‚·ãƒªãƒ¼ã‚º', '2ã‚·ãƒªãƒ¼ã‚º', '3ã‚·ãƒªãƒ¼ã‚º', '4ã‚·ãƒªãƒ¼ã‚º', '5ã‚·ãƒªãƒ¼ã‚º', '6ã‚·ãƒªãƒ¼ã‚º', '7ã‚·ãƒªãƒ¼ã‚º', '8ã‚·ãƒªãƒ¼ã‚º', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X5 M', 'Z3(æ—§)', 'Z8(æ—§)', 'E90(æ—§3ã‚·ãƒªãƒ¼ã‚º)'],
        'ãƒ¡ãƒ«ã‚»ãƒ‡ã‚¹ãƒ»ãƒ™ãƒ³ãƒ„': ['Aã‚¯ãƒ©ã‚¹', 'Bã‚¯ãƒ©ã‚¹', 'Cã‚¯ãƒ©ã‚¹', 'Eã‚¯ãƒ©ã‚¹', 'Sã‚¯ãƒ©ã‚¹', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'Gã‚¯ãƒ©ã‚¹', 'Vã‚¯ãƒ©ã‚¹', 'SL', 'SLC', 'AMG GT', 'EQA', 'EQB', 'EQE', 'EQS', 'EQG', 'ãƒã‚¤ãƒãƒƒãƒ Sã‚¯ãƒ©ã‚¹', 'C63 AMG', 'E63 AMG', 'SLS AMG(æ—§)', 'SLRãƒã‚¯ãƒ©ãƒ¼ãƒ¬ãƒ³(æ—§)', '190E(æ—§)', 'Rã‚¯ãƒ©ã‚¹(æ—§)', 'Mã‚¯ãƒ©ã‚¹(æ—§)'],
        'ã‚¢ã‚¦ãƒ‡ã‚£': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'e-tron', 'e-tron GT', 'TT', 'R8', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'RS Q3', 'RS Q8', 'S1', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
        'ãƒ•ã‚©ãƒ«ã‚¯ã‚¹ãƒ¯ãƒ¼ã‚²ãƒ³': ['ã‚´ãƒ«ãƒ•', 'ãƒãƒ­', 'T-Roc', 'T-Cross', 'ãƒ†ã‚£ã‚°ã‚¢ãƒ³', 'ID.4', 'ãƒ‘ã‚µãƒ¼ãƒˆ', 'ã‚¢ãƒ«ãƒ†ã‚ªãƒ³', 'up!', 'ãƒˆã‚¥ãƒ¼ãƒ©ãƒ³', 'ã‚·ãƒ£ãƒ©ãƒ³', 'ãƒˆã‚¥ã‚¢ãƒ¬ã‚°', 'ID.3', 'ID.5', 'ID.Buzz', 'ã‚¶ãƒ»ãƒ“ãƒ¼ãƒˆãƒ«(æ—§)', 'ã‚·ãƒ­ãƒƒã‚³(æ—§)', 'ã‚¸ã‚§ãƒƒã‚¿(æ—§)', 'ãƒ«ãƒ(æ—§)', 'ã‚¤ã‚ªã‚¹(æ—§)', 'ã‚´ãƒ«ãƒ•R', 'ã‚´ãƒ«ãƒ•GTI', 'ãƒœãƒ¼ãƒ©(æ—§)', 'ãƒ´ã‚§ãƒ³ãƒˆ(æ—§)', 'ã‚³ãƒ©ãƒ¼ãƒ‰(æ—§)', 'ã‚«ãƒ«ãƒãƒ³ã‚®ã‚¢(æ—§)', 'ã‚¿ã‚¤ãƒ—1(ãƒ“ãƒ¼ãƒˆãƒ«æ—§)', 'ã‚¿ã‚¤ãƒ—2(ãƒã‚¹æ—§)', 'ã‚¿ã‚¤ãƒ—3(æ—§)', 'ã‚´ãƒ«ãƒ• ãƒˆã‚¥ãƒ¼ãƒ©ãƒ³'],
        'ãƒãƒ«ã‚·ã‚§': ['911', '718ãƒœã‚¯ã‚¹ã‚¿ãƒ¼', '718ã‚±ã‚¤ãƒãƒ³', 'ãƒ‘ãƒŠãƒ¡ãƒ¼ãƒ©', 'ã‚«ã‚¤ã‚¨ãƒ³', 'ãƒã‚«ãƒ³', 'ã‚¿ã‚¤ã‚«ãƒ³', '918ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼(æ—§)', 'ã‚«ãƒ¬ãƒ©GT(æ—§)', '968(æ—§)', '944(æ—§)', '928(æ—§)', '356(æ—§)'],
        'ã‚ªãƒšãƒ«': ['ã‚³ãƒ«ã‚µ', 'ãƒ¢ãƒƒã‚«', 'ã‚¢ã‚¹ãƒˆãƒ©', 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒ©ãƒ³ãƒ‰', 'ã‚¶ãƒ•ã‚£ãƒ¼ãƒ©'],
    },
    'ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«': {
        'ãƒ•ã‚©ãƒ¼ãƒ‰': ['ãƒã‚¹ã‚¿ãƒ³ã‚°', 'ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼', 'ãƒ–ãƒ­ãƒ³ã‚³', 'F-150', 'GT', 'ãƒ•ã‚©ãƒ¼ã‚«ã‚¹', 'ãƒ•ã‚£ã‚¨ã‚¹ã‚¿', 'ã‚¯ãƒ¼ã‚¬', 'ã‚¨ã‚³ã‚¹ãƒãƒ¼ãƒ„', 'ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'ãƒãƒ¼ãƒ™ãƒªãƒƒã‚¯'],
        'ã‚·ãƒœãƒ¬ãƒ¼ï¼ˆGMï¼‰': ['ã‚«ãƒãƒ­', 'ã‚³ãƒ«ãƒ™ãƒƒãƒˆ', 'ã‚¿ãƒ›', 'ã‚µãƒãƒ¼ãƒãƒ³', 'ã‚·ãƒ«ãƒãƒ©ãƒ¼ãƒ‰', 'ãƒˆãƒ¬ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¶ãƒ¼', 'ã‚¨ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹', 'ãƒˆãƒ©ãƒƒã‚¯ã‚¹', 'ãƒœãƒ«ãƒˆEV', 'ã‚¹ãƒ‘ãƒ¼ã‚¯'],
        'ã‚­ãƒ£ãƒ‡ãƒ©ãƒƒã‚¯ï¼ˆGMï¼‰': ['ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰', 'XT4', 'XT5', 'XT6', 'CT4', 'CT5', 'CT6', 'ãƒªãƒªãƒƒã‚¯', 'ã‚»ãƒ¬ã‚¹ãƒ†ã‚£ãƒƒã‚¯'],
        'GMCï¼ˆGMï¼‰': ['ãƒ¦ãƒ¼ã‚³ãƒ³', 'ã‚·ã‚¨ãƒ©', 'ãƒãƒãƒ¼EV', 'ã‚¢ã‚«ãƒ‡ã‚£ã‚¢'],
        'ã‚¯ãƒ©ã‚¤ã‚¹ãƒ©ãƒ¼ï¼ˆStellantisï¼‰': ['300', 'ãƒ‘ã‚·ãƒ•ã‚£ã‚«'],
        'ã‚¸ãƒ¼ãƒ—ï¼ˆStellantisï¼‰': ['ãƒ©ãƒ³ã‚°ãƒ©ãƒ¼', 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚§ãƒ­ã‚­ãƒ¼', 'ãƒã‚§ãƒ­ã‚­ãƒ¼', 'ãƒ¬ãƒã‚²ãƒ¼ãƒ‰', 'ã‚³ãƒ³ãƒ‘ã‚¹', 'ã‚°ãƒ©ãƒ‡ã‚£ã‚¨ãƒ¼ã‚¿ãƒ¼', 'ãƒ¯ã‚´ãƒ‹ã‚¢'],
        'ãƒ€ãƒƒã‚¸ï¼ˆStellantisï¼‰': ['ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'ãƒãƒ£ãƒ¼ã‚¸ãƒ£ãƒ¼', 'ãƒ‡ãƒ¥ãƒ©ãƒ³ã‚´', 'ãƒ›ãƒ¼ãƒãƒƒãƒˆ', 'RAM 1500'],
        'ãƒ†ã‚¹ãƒ©': ['ãƒ¢ãƒ‡ãƒ«3', 'ãƒ¢ãƒ‡ãƒ«Y', 'ãƒ¢ãƒ‡ãƒ«S', 'ãƒ¢ãƒ‡ãƒ«X', 'ã‚µã‚¤ãƒãƒ¼ãƒˆãƒ©ãƒƒã‚¯', 'ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼'],
        'ãƒªãƒ³ã‚«ãƒ¼ãƒ³': ['ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼', 'ã‚¢ãƒ“ã‚¨ãƒ¼ã‚¿ãƒ¼', 'ãƒãƒ¼ãƒãƒ©ã‚¹', 'ã‚³ãƒ«ã‚»ã‚¢'],
    },
    'ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹': {
        'ãƒ«ãƒãƒ¼': ['ãƒ«ãƒ¼ãƒ†ã‚·ã‚¢', 'ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼', 'ã‚«ãƒ³ã‚°ãƒ¼', 'ãƒ¡ã‚¬ãƒ¼ãƒŒ', 'ãƒˆã‚¥ã‚¤ãƒ³ã‚´', 'ã‚¢ãƒ«ã‚«ãƒŠ', 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒ«', 'ã‚¨ã‚¹ãƒ‘ã‚¹'],
        'ãƒ—ã‚¸ãƒ§ãƒ¼': ['208', '308', '408', '508', '2008', '3008', '5008', 'ãƒªãƒ•ã‚¿ãƒ¼', 'RCZ(æ—§)'],
        'ã‚·ãƒˆãƒ­ã‚¨ãƒ³': ['C3', 'C3 ã‚¨ã‚¢ã‚¯ãƒ­ã‚¹', 'C4', 'C5 ã‚¨ã‚¢ã‚¯ãƒ­ã‚¹', 'C5 X', 'ãƒ™ãƒ«ãƒ©ãƒ³ã‚´', 'DS3(æ—§)', 'DS4(æ—§)', 'DS5(æ—§)', 'ã‚°ãƒ©ãƒ³ãƒ‰C4ã‚¹ãƒšãƒ¼ã‚¹ãƒ„ã‚¢ãƒ©ãƒ¼'],
        'DSã‚ªãƒ¼ãƒˆãƒ¢ãƒ“ãƒ«': ['DS 3', 'DS 4', 'DS 7', 'DS 9'],
        'ã‚¢ãƒ«ãƒ”ãƒ¼ãƒŒ': ['A110'],
    },
    'ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢': {
        'ãƒ•ã‚£ã‚¢ãƒƒãƒˆ': ['500 (ãƒãƒ³ã‚¯ã‚¨ãƒã‚§ãƒ³ãƒˆ)', '500e', '500X', 'ãƒ‘ãƒ³ãƒ€', 'ãƒ‰ãƒ–ãƒ­', 'ãƒ†ã‚£ãƒ¼ãƒ'],
        'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ­ãƒ¡ã‚ª': ['ã‚¸ãƒ¥ãƒªã‚¢', 'ã‚¹ãƒ†ãƒ«ãƒ´ã‚£ã‚ª', 'ãƒˆãƒŠãƒ¼ãƒ¬', 'ã‚¸ãƒ¥ãƒªã‚¨ãƒƒã‚¿(æ—§)', 'MiTo(æ—§)', '4C(æ—§)'],
        'ãƒ©ãƒ³ãƒã‚¢': ['ï¼ˆãã®ä»–ï¼‰'],
        'ãƒã‚»ãƒ©ãƒ†ã‚£': ['ã‚°ãƒ¬ã‚«ãƒ¼ãƒ¬', 'ã‚®ãƒ–ãƒª', 'ãƒ¬ãƒ´ã‚¡ãƒ³ãƒ†', 'ã‚¯ã‚¢ãƒˆãƒ­ãƒãƒ«ãƒ†', 'MC20', 'ã‚°ãƒ©ãƒ³ãƒˆã‚¥ãƒ¼ãƒªã‚ºãƒ¢'],
        'ãƒ•ã‚§ãƒ©ãƒ¼ãƒª': ['296GTB', 'SF90ã‚¹ãƒˆãƒ©ãƒ€ãƒ¼ãƒ¬', 'ãƒ­ãƒ¼ãƒ', 'ãƒ—ãƒ­ã‚µãƒ³ã‚°ã‚¨', '812ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ•ã‚¡ã‚¹ãƒˆ', 'F8ãƒˆãƒªãƒ–ãƒ¼ãƒˆ', 'ãƒãƒ«ãƒˆãƒ•ã‚£ãƒ¼ãƒM', 'ãƒ‡ã‚¤ãƒˆãƒŠSP3'],
        'ãƒ©ãƒ³ãƒœãƒ«ã‚®ãƒ¼ãƒ‹': ['ãƒ¬ãƒ´ã‚¨ãƒ«ãƒˆ', 'ã‚¦ãƒ«ã‚¹', 'ã‚¦ãƒ©ã‚«ãƒ³', 'ã‚·ã‚¢ãƒ³', 'ã‚¢ãƒ´ã‚§ãƒ³ã‚¿ãƒ‰ãƒ¼ãƒ«(æ—§)', 'ã‚¬ãƒ¤ãƒ«ãƒ‰(æ—§)', 'ãƒ ãƒ«ã‚·ã‚¨ãƒ©ã‚´(æ—§)'],
    },
    'ğŸ‡¬ğŸ‡§ ã‚¤ã‚®ãƒªã‚¹': {
        'ã‚¸ãƒ£ã‚¬ãƒ¼': ['F-PACE', 'E-PACE', 'I-PACE', 'XF', 'F-TYPE', 'XE(æ—§)'],
        'ãƒ©ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒãƒ¼': ['ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼', 'ãƒ¬ãƒ³ã‚¸ãƒ­ãƒ¼ãƒãƒ¼', 'ãƒ¬ãƒ³ã‚¸ãƒ­ãƒ¼ãƒãƒ¼ ã‚¹ãƒãƒ¼ãƒ„', 'ãƒ¬ãƒ³ã‚¸ãƒ­ãƒ¼ãƒãƒ¼ ãƒ´ã‚§ãƒ©ãƒ¼ãƒ«', 'ãƒ¬ãƒ³ã‚¸ãƒ­ãƒ¼ãƒãƒ¼ ã‚¤ãƒ´ã‚©ãƒ¼ã‚¯', 'ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼', 'ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ ã‚¹ãƒãƒ¼ãƒ„'],
        'ãƒŸãƒ‹ï¼ˆBMWå‚˜ä¸‹ï¼‰': ['3ãƒ‰ã‚¢', '5ãƒ‰ã‚¢', 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ–ãƒ«', 'ã‚¯ãƒ©ãƒ–ãƒãƒ³', 'ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼(ã‚«ãƒ³ãƒˆãƒªãƒ¼ãƒãƒ³)', 'JCW'],
        'ãƒ­ãƒ¼ãƒ«ã‚¹ãƒ»ãƒ­ã‚¤ã‚¹': ['ãƒ•ã‚¡ãƒ³ãƒˆãƒ ', 'ã‚´ãƒ¼ã‚¹ãƒˆ', 'ã‚«ãƒªãƒŠãƒ³', 'ã‚¹ãƒšã‚¯ã‚¿ãƒ¼', 'ãƒ‰ãƒ¼ãƒ³(æ—§)', 'ãƒ¬ã‚¤ã‚¹(æ—§)'],
        'ãƒ™ãƒ³ãƒˆãƒ¬ãƒ¼': ['ã‚³ãƒ³ãƒãƒãƒ³ã‚¿ãƒ«GT', 'ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ã‚¹ãƒ‘ãƒ¼', 'ãƒ™ãƒ³ãƒ†ã‚¤ã‚¬', 'ãƒãƒˆã‚¥ãƒ¼ãƒ«'],
        'ã‚¢ã‚¹ãƒˆãƒ³ãƒãƒ¼ãƒ†ã‚£ãƒ³': ['DB12', 'DBS', 'ãƒ´ã‚¡ãƒ³ãƒ†ãƒ¼ã‚¸', 'DBX', 'ãƒ´ã‚¡ãƒ«ãƒãƒ©'],
        'ãƒã‚¯ãƒ©ãƒ¼ãƒ¬ãƒ³': ['750S', 'ã‚¢ãƒ«ãƒˆã‚¥ãƒ¼ãƒ©', 'GT', '765LT', 'P1(æ—§)', '570S(æ—§)', '650S(æ—§)', 'MP4-12C(æ—§)'],
    },
    'ğŸ‡¸ğŸ‡ª ã‚¹ã‚¦ã‚§ãƒ‡ãƒ³': {
        'ãƒœãƒ«ãƒœ': ['XC40', 'XC60', 'XC90', 'EX30', 'EX90', 'S60', 'S90', 'V60', 'V90'],
        'ã‚µãƒ¼ãƒ–ï¼ˆç”Ÿç”£çµ‚äº†ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡°ğŸ‡· éŸ“å›½': {
        'ãƒ’ãƒ§ãƒ³ãƒ‡ï¼ˆç¾ä»£ï¼‰': ['IONIQ 5', 'IONIQ 6', 'ã‚³ãƒŠ', 'Tucson', 'Santa Fe', 'Palisade', 'Elantra', 'Sonata', 'Nexo'],
        'ã‚­ã‚¢': ['EV6', 'EV9', 'Sportage', 'Sorento', 'Telluride', 'Carnival', 'K5', 'Niro', 'Soul'],
        'ã‚¸ã‚§ãƒã‚·ã‚¹': ['G70', 'G80', 'G90', 'GV60', 'GV70', 'GV80'],
    },
    'ğŸ‡¨ğŸ‡³ ä¸­å›½': {
        'BYD': ['ATTO 3', 'DOLPHIN', 'SEAL', 'HAN', 'TANG'],
        'å‰åˆ©ï¼ˆã‚¸ãƒ¼ãƒªãƒ¼ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
        'é•·å®‰æ±½è»Š': ['ï¼ˆãã®ä»–ï¼‰'],
        'é•·åŸæ±½è»Šï¼ˆã‚°ãƒ¬ãƒ¼ãƒˆã‚¦ã‚©ãƒ¼ãƒ«ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
        'NIOï¼ˆè”šæ¥ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
        'Xpengï¼ˆã‚·ãƒ£ã‚ªãƒšãƒ³ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
        'Li Autoï¼ˆç†æƒ³æ±½è»Šï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
        'ç´…æ——ï¼ˆãƒ›ãƒ³ãƒãƒ¼ï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡®ğŸ‡³ ã‚¤ãƒ³ãƒ‰': {
        'ã‚¿ã‚¿ãƒ»ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚º': ['ï¼ˆãã®ä»–ï¼‰'],
        'ãƒãƒ’ãƒ³ãƒ‰ãƒ©': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³': {
        'ã‚»ã‚¢ãƒˆ': ['ï¼ˆãã®ä»–ï¼‰'],
        'ã‚«ãƒƒãƒ—ãƒ©': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡·ğŸ‡º ãƒ­ã‚·ã‚¢': {
        'ãƒ©ãƒ¼ãƒ€ï¼ˆAvtoVAZï¼‰': ['ï¼ˆãã®ä»–ï¼‰'],
    },
    'ğŸ‡¨ğŸ‡¿ ãƒã‚§ã‚³': {
        'ã‚·ãƒ¥ã‚³ãƒ€': ['ï¼ˆãã®ä»–ï¼‰'],
    },
}

# (ä¸­ç•¥ ... ) recommendation_data
recommendation_data = {
    'ãƒˆãƒ¨ã‚¿': {'UserA': 5, 'UserB': 1, 'UserC': 4, 'UserD': 5, 'UserE': 2},
    'ãƒ›ãƒ³ãƒ€': {'UserA': 4, 'UserB': 5, 'UserC': 2, 'UserD': 4, 'UserE': 5},
    'æ—¥ç”£': {'UserA': 1, 'UserB': 3, 'UserC': 5, 'UserD': 2, 'UserE': 4},
    'BMW': {'UserA': 5, 'UserB': 1, 'UserC': 5, 'UserD': 5, 'UserE': 1},
    'ãƒãƒ„ãƒ€': {'UserA': 2, 'UserB': 4, 'UserC': 3, 'UserD': 1, 'UserE': 5},
    'ã‚¹ãƒãƒ«': {'UserA': 3, 'UserB': 5, 'UserC': 3, 'UserD': 3, 'UserE': 4},
    'ãƒ¡ãƒ«ã‚»ãƒ‡ã‚¹ãƒ»ãƒ™ãƒ³ãƒ„': {'UserA': 5, 'UserB': 2, 'UserC': 5, 'UserD': 4, 'UserE': 1}, 
    'ã‚¢ã‚¦ãƒ‡ã‚£': {'UserA': 4, 'UserB': 1, 'UserC': 4, 'UserD': 5, 'UserE': 2},    
    'ã‚¹ã‚ºã‚­': {'UserA': 1, 'UserB': 5, 'UserC': 1, 'UserD': 1, 'UserE': 5},
    'ãƒ€ã‚¤ãƒãƒ„': {'UserA': 1, 'UserB': 5, 'UserC': 1, 'UserD': 1, 'UserE': 5},
    'ãã®ä»–': {'UserA': 1, 'UserB': 1, 'UserC': 1, 'UserD': 1, 'UserE': 1},
}
interest_df = pd.DataFrame(recommendation_data).fillna(0)

# (ä¸­ç•¥ ... ) get_price_bonus
def get_price_bonus(maker):
    if maker in ['ãƒ•ã‚§ãƒ©ãƒ¼ãƒª', 'ãƒ©ãƒ³ãƒœãƒ«ã‚®ãƒ¼ãƒ‹', 'ãƒ­ãƒ¼ãƒ«ã‚¹ãƒ»ãƒ­ã‚¤ã‚¹', 'ãƒ™ãƒ³ãƒˆãƒ¬ãƒ¼', 'ã‚¢ã‚¹ãƒˆãƒ³ãƒãƒ¼ãƒ†ã‚£ãƒ³', 'ãƒã‚¯ãƒ©ãƒ¼ãƒ¬ãƒ³']: return 15000000 
    elif maker in ['ãƒãƒ«ã‚·ã‚§', 'ãƒã‚»ãƒ©ãƒ†ã‚£', 'ãƒ©ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒãƒ¼', 'ã‚­ãƒ£ãƒ‡ãƒ©ãƒƒã‚¯ï¼ˆGMï¼‰', 'ãƒ¬ã‚¯ã‚µã‚¹', 'ã‚¸ã‚§ãƒã‚·ã‚¹']: return 4000000 
    elif maker in ['BMW', 'ãƒ¡ãƒ«ã‚»ãƒ‡ã‚¹ãƒ»ãƒ™ãƒ³ãƒ„', 'ã‚¢ã‚¦ãƒ‡ã‚£', 'ãƒ†ã‚¹ãƒ©', 'ã‚¸ãƒ£ã‚¬ãƒ¼', 'ãƒªãƒ³ã‚«ãƒ¼ãƒ³', 'ãƒœãƒ«ãƒœ']: return 2000000 
    elif maker in ['ãƒˆãƒ¨ã‚¿', 'æ—¥ç”£', 'ãƒ›ãƒ³ãƒ€', 'ã‚¹ãƒãƒ«', 'ãƒãƒ„ãƒ€', 'ä¸‰è±', 'ãƒ•ã‚©ãƒ¼ãƒ‰', 'ã‚¸ãƒ¼ãƒ—ï¼ˆStellantisï¼‰', 'ãƒ«ãƒãƒ¼', 'ãƒ—ã‚¸ãƒ§ãƒ¼', 'ã‚·ãƒˆãƒ­ã‚¨ãƒ³', 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ­ãƒ¡ã‚ª', 'ãƒ’ãƒ§ãƒ³ãƒ‡ï¼ˆç¾ä»£ï¼‰']: return 500000 
    elif maker in ['ã‚¹ã‚ºã‚­', 'ãƒ€ã‚¤ãƒãƒ„', 'ãƒ•ã‚£ã‚¢ãƒƒãƒˆ', 'ã‚·ãƒ¥ã‚³ãƒ€', 'BYD']: return -200000 
    else: return 0

# (ä¸­ç•¥ ... ) ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—ã¨ä¹—è»Šäººæ•°ã®é–¢æ•° (get_body_type, get_seating_capacity, get_body_type_bonus)
BODY_TYPE_KEYWORDS = {
    'è»½è‡ªå‹•è»Š': ['N-BOX', 'ã‚¿ãƒ³ãƒˆ', 'ã‚¹ãƒšãƒ¼ã‚·ã‚¢', 'ãƒ ãƒ¼ãƒ´', 'ãƒ¯ã‚´ãƒ³R', 'ã‚µã‚¯ãƒ©', 'ãƒ«ãƒ¼ã‚¯ã‚¹', 'ãƒ‡ã‚¤ã‚º', 'eK', 'ãƒã‚¹ãƒ©ãƒ¼', 'ã‚¸ãƒ ãƒ‹ãƒ¼', 'ã‚¿ãƒ•ãƒˆ', 'ã‚¦ã‚§ã‚¤ã‚¯', 'ã‚³ãƒšãƒ³', 'S660', 'ã‚¢ãƒ«ãƒˆ', 'ãƒ©ãƒ‘ãƒ³', 'ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹', 'ã‚­ãƒ£ã‚¹ãƒˆ', 'ã‚­ãƒ£ãƒ³ãƒã‚¹', 'ã‚¢ãƒˆãƒ¬ãƒ¼', 'ãƒã‚¤ã‚¼ãƒƒãƒˆ', 'ã‚¨ãƒ–ãƒªã‚¤', 'N-WGN', 'N-ONE', 'N-VAN', 'ãƒ©ã‚¤ãƒ•', 'ãƒãƒ¢ã‚¹', 'ã‚¼ã‚¹ãƒˆ', 'ã‚¢ã‚¤', 'ãƒ‘ã‚¸ã‚§ãƒ­ãƒŸãƒ‹', 'Kei', 'ãƒ‘ãƒ¬ãƒƒãƒˆ', 'MRãƒ¯ã‚´ãƒ³', 'ã‚»ãƒ«ãƒœ', 'ã‚«ãƒ—ãƒãƒ¼ãƒ', 'ãƒ„ã‚¤ãƒ³', 'ã‚­ãƒ£ãƒ©', 'ãƒŸãƒ©', 'ã‚¸ãƒ¼ãƒ', 'ãƒŸã‚¼ãƒƒãƒˆ', 'ã‚ªãƒ—ãƒ†ã‚£', 'ã‚¨ãƒƒã‚»', 'ã‚½ãƒ‹ã‚«', 'ãƒ†ãƒªã‚ªã‚¹ã‚­ãƒƒãƒ‰', 'MAX', 'ãƒã‚¤ã‚­ãƒƒãƒ‰', 'ãƒ¢ã‚³', 'ã‚ªãƒƒãƒ†ã‚£', 'ãƒ•ãƒ¬ã‚¢', 'ã‚­ãƒ£ãƒ­ãƒ«', 'ã‚¹ãƒ†ãƒ©', 'ãƒ—ãƒ¬ã‚ª', 'R1', 'R2', 'ã‚·ãƒ•ã‚©ãƒ³', 'ãƒ«ã‚¯ãƒ©'],
    'SUV': ['RAV4', 'ãƒãƒªã‚¢ãƒ¼', 'ãƒ©ãƒ³ãƒ‰ã‚¯ãƒ«ãƒ¼ã‚¶ãƒ¼', 'ãƒ¤ãƒªã‚¹ã‚¯ãƒ­ã‚¹', 'ã‚«ãƒ­ãƒ¼ãƒ©ã‚¯ãƒ­ã‚¹', 'C-HR', 'ãƒ©ã‚¤ã‚º', 'FJã‚¯ãƒ«ãƒ¼ã‚¶ãƒ¼', 'RX', 'NX', 'LX', 'UX', 'GX', 'ã‚¨ã‚¯ã‚¹ãƒˆãƒ¬ã‚¤ãƒ«', 'ã‚­ãƒƒã‚¯ã‚¹', 'ã‚¢ãƒªã‚¢', 'ã‚¸ãƒ¥ãƒ¼ã‚¯', 'ãƒ‡ãƒ¥ã‚¢ãƒªã‚¹', 'ãƒ ãƒ©ãƒ¼ãƒ', 'ãƒ´ã‚§ã‚¼ãƒ«', 'ZR-V', 'CR-V', 'ã‚¯ãƒ­ã‚¹ãƒ­ãƒ¼ãƒ‰', 'CX-5', 'CX-30', 'CX-60', 'CX-3', 'CX-8', 'MX-30', 'CX-7', 'ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆ', 'ãƒ•ã‚©ãƒ¬ã‚¹ã‚¿ãƒ¼', 'ãƒ¬ã‚¬ã‚·ã‚£ ã‚¢ã‚¦ãƒˆãƒãƒƒã‚¯', 'ã‚¯ãƒ­ã‚¹ãƒˆãƒ¬ãƒƒã‚¯', 'XV', 'ã‚¢ã‚¦ãƒˆãƒ©ãƒ³ãƒ€ãƒ¼', 'ã‚¨ã‚¯ãƒªãƒ—ã‚¹ã‚¯ãƒ­ã‚¹', 'RVR', 'ãƒ‘ã‚¸ã‚§ãƒ­', 'ãƒˆãƒ©ã‚¤ãƒˆãƒ³', 'ã‚¨ã‚¹ã‚¯ãƒ¼ãƒ‰', 'ã‚¯ãƒ­ã‚¹ãƒ“ãƒ¼', 'ãƒ­ãƒƒã‚­ãƒ¼', 'ãƒ“ãƒ¼ã‚´', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'iX', 'iX3', 'XM', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'Gã‚¯ãƒ©ã‚¹', 'EQA', 'EQB', 'EQC', 'EQE SUV', 'EQS SUV', 'Mã‚¯ãƒ©ã‚¹', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'e-tron', 'T-Roc', 'T-Cross', 'ãƒ†ã‚£ã‚°ã‚¢ãƒ³', 'ãƒˆã‚¥ã‚¢ãƒ¬ã‚°', 'ã‚«ã‚¤ã‚¨ãƒ³', 'ãƒã‚«ãƒ³', 'ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼', 'ãƒ–ãƒ­ãƒ³ã‚³', 'F-150', 'ã‚¯ãƒ¼ã‚¬', 'ã‚¨ã‚³ã‚¹ãƒãƒ¼ãƒ„', 'ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'ãƒãƒ¼ãƒ™ãƒªãƒƒã‚¯', 'ã‚¿ãƒ›', 'ã‚µãƒãƒ¼ãƒãƒ³', 'ã‚·ãƒ«ãƒãƒ©ãƒ¼ãƒ‰', 'ãƒˆãƒ¬ã‚¤ãƒ«ãƒ–ãƒ¬ã‚¤ã‚¶ãƒ¼', 'ã‚¨ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹', 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰', 'XT4', 'XT5', 'XT6', 'ãƒªãƒªãƒƒã‚¯', 'ãƒ¦ãƒ¼ã‚³ãƒ³', 'ã‚·ã‚¨ãƒ©', 'ãƒãƒãƒ¼', 'ãƒ©ãƒ³ã‚°ãƒ©ãƒ¼', 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚§ãƒ­ã‚­ãƒ¼', 'ãƒã‚§ãƒ­ã‚­ãƒ¼', 'ãƒ¬ãƒã‚²ãƒ¼ãƒ‰', 'ã‚³ãƒ³ãƒ‘ã‚¹', 'ã‚°ãƒ©ãƒ‡ã‚£ã‚¨ãƒ¼ã‚¿ãƒ¼', 'ãƒ¯ã‚´ãƒ‹ã‚¢', 'ãƒ‡ãƒ¥ãƒ©ãƒ³ã‚´', 'RAM', 'ãƒ¢ãƒ‡ãƒ«Y', 'ãƒ¢ãƒ‡ãƒ«X', 'ã‚µã‚¤ãƒãƒ¼ãƒˆãƒ©ãƒƒã‚¯', 'ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼', 'ã‚¢ãƒ“ã‚¨ãƒ¼ã‚¿ãƒ¼', 'ãƒãƒ¼ãƒãƒ©ã‚¹', 'ã‚³ãƒ«ã‚»ã‚¢', 'ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼', 'ã‚¢ãƒ«ã‚«ãƒŠ', '2008', '3008', '5008', 'C3 ã‚¨ã‚¢ã‚¯ãƒ­ã‚¹', 'C5 ã‚¨ã‚¢ã‚¯ãƒ­ã‚¹', 'DS 7', '500X', 'ã‚¹ãƒ†ãƒ«ãƒ´ã‚£ã‚ª', 'ãƒˆãƒŠãƒ¼ãƒ¬', 'ã‚¦ãƒ«ã‚¹', 'ãƒ¬ãƒ´ã‚¡ãƒ³ãƒ†', 'ã‚°ãƒ¬ã‚«ãƒ¼ãƒ¬', 'F-PACE', 'E-PACE', 'I-PACE', 'ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼', 'ãƒ¬ãƒ³ã‚¸ãƒ­ãƒ¼ãƒãƒ¼', 'ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼', 'ã‚¤ãƒ´ã‚©ãƒ¼ã‚¯', 'ãƒ´ã‚§ãƒ©ãƒ¼ãƒ«', 'ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼', 'ãƒ™ãƒ³ãƒ†ã‚¤ã‚¬', 'DBX', 'ã‚«ãƒªãƒŠãƒ³', 'XC40', 'XC60', 'XC90', 'EX30', 'EX90', 'ã‚³ãƒŠ', 'Tucson', 'Santa Fe', 'Palisade', 'Sportage', 'Sorento', 'Telluride', 'GV60', 'GV70', 'GV80', 'ATTO 3', 'TANG'],
    'ãƒŸãƒ‹ãƒãƒ³': ['ã‚·ã‚¨ãƒ³ã‚¿', 'ã‚¢ãƒ«ãƒ•ã‚¡ãƒ¼ãƒ‰', 'ãƒ´ã‚©ã‚¯ã‚·ãƒ¼', 'ãƒã‚¢', 'ã‚¨ã‚¹ãƒ†ã‚£ãƒ', 'ã‚¦ã‚£ãƒƒã‚·ãƒ¥', 'ã‚¹ãƒšã‚¤ãƒ‰', 'ãƒãƒ«ãƒ†', 'ã‚»ãƒ¬ãƒŠ', 'ã‚¨ãƒ«ã‚°ãƒ©ãƒ³ãƒ‰', 'ãƒ©ãƒ•ã‚§ã‚¹ã‚¿', 'ã‚¹ãƒ†ãƒƒãƒ—ãƒ¯ã‚´ãƒ³', 'ã‚ªãƒ‡ãƒƒã‚»ã‚¤', 'ãƒ•ãƒªãƒ¼ãƒ‰', 'ã‚¨ãƒªã‚·ã‚ªãƒ³', 'ãƒ¢ãƒ“ãƒªã‚ª', 'ã‚¸ã‚§ã‚¤ãƒ‰', 'MPV', 'ãƒ—ãƒ¬ãƒã‚·ãƒ¼', 'ãƒ“ã‚¢ãƒ³ãƒ†', 'ã‚¨ã‚¯ã‚·ãƒ¼ã‚¬', 'ãƒ‡ãƒªã‚«D:5', 'ãƒ‡ãƒªã‚«D:2', 'ã‚°ãƒ©ãƒ³ãƒ‡ã‚£ã‚¹', 'ãƒ‡ã‚£ã‚ªãƒ³', 'ã‚½ãƒªã‚ª', 'ãƒ©ãƒ³ãƒ‡ã‚£', 'Vã‚¯ãƒ©ã‚¹', 'ã‚·ãƒ£ãƒ©ãƒ³', 'ãƒˆã‚¥ãƒ¼ãƒ©ãƒ³', 'ã‚´ãƒ«ãƒ• ãƒˆã‚¥ãƒ¼ãƒ©ãƒ³', 'ãƒ‘ã‚·ãƒ•ã‚£ã‚«', 'ã‚«ãƒ³ã‚°ãƒ¼', 'ãƒªãƒ•ã‚¿ãƒ¼', 'ãƒ™ãƒ«ãƒ©ãƒ³ã‚´', 'C4ã‚¹ãƒšãƒ¼ã‚¹ãƒ„ã‚¢ãƒ©ãƒ¼', 'ãƒ‰ãƒ–ãƒ­', 'Carnival'],
    'ã‚¹ãƒãƒ¼ãƒ„/ã‚¯ãƒ¼ãƒš': ['86', 'ã‚¹ãƒ¼ãƒ—ãƒ©', 'GT-R', 'ãƒ•ã‚§ã‚¢ãƒ¬ãƒ‡ã‚£Z', 'ã‚·ãƒ«ãƒ“ã‚¢', '180SX', 'ã‚·ãƒ“ãƒƒã‚¯ ã‚¿ã‚¤ãƒ—R', 'S660', 'NSX', 'S2000', 'CR-Z', 'ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼', 'RX-8', 'RX-7', 'AZ-1', 'WRX', 'BRZ', 'ãƒ©ãƒ³ã‚µãƒ¼ã‚¨ãƒœãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³', 'GTO', 'FTO', 'ã‚«ãƒ—ãƒãƒ¼ãƒ', 'ã‚¢ãƒ«ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹', 'ã‚³ãƒšãƒ³', 'Z4', 'M2', 'M3', 'M4', 'M5', 'M8', '2ã‚·ãƒªãƒ¼ã‚ºã‚¯ãƒ¼ãƒš', '4ã‚·ãƒªãƒ¼ã‚º', '6ã‚·ãƒªãƒ¼ã‚º', '8ã‚·ãƒªãƒ¼ã‚º', 'SL', 'SLC', 'AMG GT', 'C63', 'E63', 'SLS', 'SLR', 'TT', 'R8', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'Sãƒ¢ãƒ‡ãƒ«', '911', '718ãƒœã‚¯ã‚¹ã‚¿ãƒ¼', '718ã‚±ã‚¤ãƒãƒ³', 'GT', 'ãƒã‚¹ã‚¿ãƒ³ã‚°', 'ã‚«ãƒãƒ­', 'ã‚³ãƒ«ãƒ™ãƒƒãƒˆ', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'ãƒãƒ£ãƒ¼ã‚¸ãƒ£ãƒ¼', 'ãƒã‚¤ãƒ‘ãƒ¼', 'ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼(ãƒ†ã‚¹ãƒ©)', 'A110', 'RCZ', '4C', 'MC20', 'ãƒ•ã‚§ãƒ©ãƒ¼ãƒª', 'ãƒ©ãƒ³ãƒœãƒ«ã‚®ãƒ¼ãƒ‹', 'F-TYPE', 'JCW', 'ãƒ­ãƒ¼ãƒ«ã‚¹ãƒ­ã‚¤ã‚¹(ã‚¯ãƒ¼ãƒš)', 'ãƒ™ãƒ³ãƒˆãƒ¬ãƒ¼(ã‚¯ãƒ¼ãƒš)', 'ã‚¢ã‚¹ãƒˆãƒ³ãƒãƒ¼ãƒ†ã‚£ãƒ³', 'ãƒã‚¯ãƒ©ãƒ¼ãƒ¬ãƒ³'],
    'ã‚»ãƒ€ãƒ³': ['ãƒ—ãƒªã‚¦ã‚¹', 'ã‚¯ãƒ©ã‚¦ãƒ³', 'ãƒã‚¤ã‚¨ãƒ¼ã‚¹', 'ã‚«ãƒ ãƒª', 'MIRAI', 'ãƒãƒ¼ã‚¯X', 'ã‚»ãƒ³ãƒãƒ¥ãƒªãƒ¼', 'LS', 'IS', 'ES', 'GS', 'ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³', 'ãƒ•ãƒ¼ã‚¬', 'ã‚·ãƒ¼ãƒ', 'ãƒ†ã‚£ã‚¢ãƒŠ', 'ã‚¢ã‚³ãƒ¼ãƒ‰', 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', 'ã‚¤ãƒ³ã‚µã‚¤ãƒˆ', 'ã‚°ãƒ¬ã‚¤ã‚¹', 'ã‚¯ãƒ©ãƒªãƒ†ã‚£', 'Mazda3ã‚»ãƒ€ãƒ³', 'Mazda6ã‚»ãƒ€ãƒ³', 'ã‚¢ãƒ†ãƒ³ã‚¶ã‚»ãƒ€ãƒ³', 'ã‚¢ã‚¯ã‚»ãƒ©ã‚»ãƒ€ãƒ³', 'ãƒ¬ã‚¬ã‚·ã‚£B4', 'ã‚­ã‚¶ã‚·', '3ã‚·ãƒªãƒ¼ã‚º', '5ã‚·ãƒªãƒ¼ã‚º', '7ã‚·ãƒªãƒ¼ã‚º', 'Cã‚¯ãƒ©ã‚¹', 'Eã‚¯ãƒ©ã‚¹', 'Sã‚¯ãƒ©ã‚¹', 'CLA', 'CLS', 'A3ã‚»ãƒ€ãƒ³', 'A4', 'A5ã‚¹ãƒãƒ¼ãƒ„ãƒãƒƒã‚¯', 'A6', 'A7', 'A8', 'ãƒ‘ã‚µãƒ¼ãƒˆ', 'ã‚¢ãƒ«ãƒ†ã‚ªãƒ³', 'ã‚¸ã‚§ãƒƒã‚¿', 'ãƒœãƒ¼ãƒ©', 'ãƒ´ã‚§ãƒ³ãƒˆ', 'ãƒ‘ãƒŠãƒ¡ãƒ¼ãƒ©', 'ã‚¿ã‚¤ã‚«ãƒ³', '300', 'ãƒ¢ãƒ‡ãƒ«3', 'ãƒ¢ãƒ‡ãƒ«S', '508', 'DS 9', 'ã‚¸ãƒ¥ãƒªã‚¢', 'ã‚®ãƒ–ãƒª', 'ã‚¯ã‚¢ãƒˆãƒ­ãƒãƒ«ãƒ†', 'XF', 'XE', 'S60', 'S90', 'Elantra', 'Sonata', 'G70', 'G80', 'G90', 'SEAL', 'HAN', 'ç´…æ——'],
    'ãƒãƒƒãƒãƒãƒƒã‚¯/ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ': ['ã‚«ãƒ­ãƒ¼ãƒ©', 'ãƒ¤ãƒªã‚¹', 'ã‚¢ã‚¯ã‚¢', 'ãƒ«ãƒ¼ãƒŸãƒ¼', 'ãƒ‘ãƒƒã‚½', 'ãƒ´ã‚£ãƒƒãƒ„', 'bB', 'ãƒãƒ¼ãƒˆ', 'ãƒªãƒ¼ãƒ•', 'ãƒãƒ¼ãƒ', 'ã‚­ãƒ¥ãƒ¼ãƒ–', 'ãƒ•ã‚£ãƒƒãƒˆ', 'ã‚·ãƒ“ãƒƒã‚¯', 'e', 'ã‚·ãƒ£ãƒˆãƒ«', 'Mazda2', 'Mazda3', 'ãƒ‡ãƒŸã‚ª', 'ã‚¢ã‚¯ã‚»ãƒ©', 'ãƒ™ãƒªãƒ¼ã‚µ', 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚µ', 'ã‚¸ãƒ£ã‚¹ãƒ†ã‚£', 'ãƒˆãƒ¬ã‚¸ã‚¢', 'ãƒŸãƒ©ãƒ¼ã‚¸ãƒ¥', 'ã‚³ãƒ«ãƒˆ', 'ã‚¹ã‚¤ãƒ•ãƒˆ', 'ã‚¤ã‚°ãƒ‹ã‚¹', 'ãƒãƒ¬ãƒ¼ãƒ', 'ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥', 'ã‚¨ãƒªã‚ª', 'ãƒˆãƒ¼ãƒ«', 'ãƒ–ãƒ¼ãƒ³', 'ã‚¯ãƒ¼', 'ã‚¹ãƒˆãƒ¼ãƒªã‚¢', 'ã‚·ãƒ£ãƒ¬ãƒ¼ãƒ‰', 'CT', '1ã‚·ãƒªãƒ¼ã‚º', 'i3', 'Aã‚¯ãƒ©ã‚¹', 'Bã‚¯ãƒ©ã‚¹', 'A1', 'A3', 'ã‚´ãƒ«ãƒ•', 'ãƒãƒ­', 'up!', 'ID.3', 'ãƒ“ãƒ¼ãƒˆãƒ«', 'ãƒ«ãƒ', 'ã‚³ãƒ«ã‚µ', 'ã‚¢ã‚¹ãƒˆãƒ©', 'ãƒ•ã‚©ãƒ¼ã‚«ã‚¹', 'ãƒ•ã‚£ã‚¨ã‚¹ã‚¿', 'ãƒœãƒ«ãƒˆEV', 'ã‚¹ãƒ‘ãƒ¼ã‚¯', 'ãƒ«ãƒ¼ãƒ†ã‚·ã‚¢', 'ãƒ¡ã‚¬ãƒ¼ãƒŒ', 'ãƒˆã‚¥ã‚¤ãƒ³ã‚´', '208', '308', 'C3', 'C4', 'DS 3', 'DS 4', '500', 'ãƒ‘ãƒ³ãƒ€', 'ãƒ†ã‚£ãƒ¼ãƒ', 'ã‚¸ãƒ¥ãƒªã‚¨ãƒƒã‚¿', 'MiTo', '3ãƒ‰ã‚¢', '5ãƒ‰ã‚¢', 'ã‚¯ãƒ©ãƒ–ãƒãƒ³', 'V60', 'V90', 'IONIQ', 'EV6', 'Niro', 'Soul', 'K5', 'DOLPHIN'],
    'ãƒãƒ³/ãƒˆãƒ©ãƒƒã‚¯': ['ãƒã‚¤ã‚¨ãƒ¼ã‚¹', 'NV350', 'NV200', 'ã‚µãƒ³ãƒãƒ¼', 'ãƒ—ãƒ­ãƒœãƒƒã‚¯ã‚¹', 'ã‚µã‚¯ã‚·ãƒ¼ãƒ‰', 'ãƒœãƒ³ã‚´', 'ã‚¿ã‚¦ãƒ³ãƒœãƒƒã‚¯ã‚¹', 'ãƒŸãƒ‹ã‚­ãƒ£ãƒ–', 'F-150', 'ã‚·ãƒ«ãƒãƒ©ãƒ¼ãƒ‰', 'ã‚·ã‚¨ãƒ©', 'RAM', 'ãƒˆãƒ©ã‚¤ãƒˆãƒ³', 'ãƒã‚¤ãƒ©ãƒƒã‚¯ã‚¹'],
}
MODEL_TO_BODYTYPE = {}
for body_type, models in BODY_TYPE_KEYWORDS.items():
    for model in models:
        if model.lower() not in MODEL_TO_BODYTYPE:
            MODEL_TO_BODYTYPE[model.lower()] = body_type

def get_body_type(model_name):
    model_name_lower = str(model_name).lower().split('(')[0].strip()
    bt = MODEL_TO_BODYTYPE.get(model_name_lower, None)
    if bt:
        return bt
    return 'ãã®ä»–'

def get_seating_capacity(model_name):
    model_name_lower = str(model_name).lower()
    if any(m in model_name_lower for m in ['86', 'ã‚¹ãƒ¼ãƒ—ãƒ©', 'gt-r', 'ãƒ•ã‚§ã‚¢ãƒ¬ãƒ‡ã‚£z', 's660', 'nsx', 'ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼', 'rx-7', 'rx-8', 'brz', 's2000', 'az-1', 'ã‚«ãƒ—ãƒãƒ¼ãƒ', 'ã‚³ãƒšãƒ³', 'ãƒ“ãƒ¼ãƒˆ', 'ãƒ„ã‚¤ãƒ³', 'ã‚­ãƒ£ãƒ©', 'ãƒã‚¤ãƒ†ã‚£ãƒœãƒ¼ã‚¤', '911', 'ãƒœã‚¯ã‚¹ã‚¿ãƒ¼', 'ã‚±ã‚¤ãƒãƒ³', 'z4', 'sl', 'slc', 'amg gt', 'tt', 'r8', 'ã‚³ãƒ«ãƒ™ãƒƒãƒˆ', 'ã‚«ãƒãƒ­', 'ãƒã‚¹ã‚¿ãƒ³ã‚°', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'ãƒãƒ£ãƒ¼ã‚¸ãƒ£ãƒ¼', 'f-type', 'a110', '4c', 'mc20', 'ãƒ•ã‚§ãƒ©ãƒ¼ãƒª', 'ãƒ©ãƒ³ãƒœãƒ«ã‚®ãƒ¼ãƒ‹', 'ãƒã‚¯ãƒ©ãƒ¼ãƒ¬ãƒ³', 'ã‚¢ã‚¹ãƒˆãƒ³ãƒãƒ¼ãƒ†ã‚£ãƒ³']):
        return 2
    elif any(m in model_name_lower for m in ['ã‚µã‚¯ãƒ©', 'ãƒ«ãƒ¼ã‚¯ã‚¹', 'ãƒ‡ã‚¤ã‚º', 'n-box', 'n-wgn', 'n-one', 'n-van', 'ãƒ©ã‚¤ãƒ•', 'ã‚¼ã‚¹ãƒˆ', 'ãƒãƒ¢ã‚¹', 'eK', 'i-miev', 'ã‚¢ã‚¤', 'ãƒˆãƒƒãƒ', 'ã‚¸ãƒ ãƒ‹ãƒ¼', 'ãƒã‚¹ãƒ©ãƒ¼', 'ã‚¹ãƒšãƒ¼ã‚·ã‚¢', 'ãƒ¯ã‚´ãƒ³r', 'ã‚¢ãƒ«ãƒˆ', 'ãƒ©ãƒ‘ãƒ³', 'ã‚¨ãƒ–ãƒªã‚¤ãƒ¯ã‚´ãƒ³', 'kei', 'ãƒ‘ãƒ¬ãƒƒãƒˆ', 'mrãƒ¯ã‚´ãƒ³', 'ã‚»ãƒ«ãƒœ', 'ã‚¿ãƒ³ãƒˆ', 'ãƒ ãƒ¼ãƒ´', 'ã‚¿ãƒ•ãƒˆ', 'ãƒŸãƒ©ã‚¤ãƒ¼ã‚¹', 'ã‚¦ã‚§ã‚¤ã‚¯', 'ã‚¢ãƒˆãƒ¬ãƒ¼', 'ãƒã‚¤ã‚¼ãƒƒãƒˆ', 'ã‚­ãƒ£ã‚¹ãƒˆ', 'ãƒŸãƒ©', 'ã‚¨ãƒƒã‚»', 'ã‚½ãƒ‹ã‚«', 'ãƒã‚¤ã‚­ãƒƒãƒ‰', 'max', 'ã‚ªãƒ—ãƒ†ã‚£', 'up!', '500', 'ãƒãƒ³ã‚¯ã‚¨ãƒã‚§ãƒ³ãƒˆ', 'ãƒŸãƒ‹', '3ãƒ‰ã‚¢', 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ–ãƒ«']):
        return 4
    elif any(m in model_name_lower for m in ['ã‚¢ãƒ«ãƒ•ã‚¡ãƒ¼ãƒ‰', 'ãƒ´ã‚©ã‚¯ã‚·ãƒ¼', 'ãƒã‚¢', 'ã‚¨ã‚¹ãƒ†ã‚£ãƒ', 'ã‚»ãƒ¬ãƒŠ', 'ã‚¨ãƒ«ã‚°ãƒ©ãƒ³ãƒ‰', 'ã‚¹ãƒ†ãƒƒãƒ—ãƒ¯ã‚´ãƒ³', 'ã‚ªãƒ‡ãƒƒã‚»ã‚¤', 'ãƒ•ãƒªãƒ¼ãƒ‰', 'ã‚¨ãƒªã‚·ã‚ªãƒ³', 'ãƒ¢ãƒ“ãƒªã‚ª', 'cx-8', 'mpv', 'ãƒ“ã‚¢ãƒ³ãƒ†', 'ãƒ—ãƒ¬ãƒã‚·ãƒ¼', 'ã‚¨ã‚¯ã‚·ãƒ¼ã‚¬', 'ãƒ‡ãƒªã‚«d:5', 'ãƒ©ãƒ³ãƒ‡ã‚£', 'ã‚·ãƒ£ãƒ©ãƒ³', 'ãƒˆã‚¥ãƒ¼ãƒ©ãƒ³', 'vã‚¯ãƒ©ã‚¹', 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒ‰', 'ã‚¿ãƒ›', 'ã‚µãƒãƒ¼ãƒãƒ³', 'ãƒ¦ãƒ¼ã‚³ãƒ³', 'ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼', 'ãƒ‘ã‚·ãƒ•ã‚£ã‚«', 'ãƒ¯ã‚´ãƒ‹ã‚¢', 'ãƒ‡ãƒ¥ãƒ©ãƒ³ã‚´', 'ãƒ™ãƒ«ãƒ©ãƒ³ã‚´', 'ãƒªãƒ•ã‚¿ãƒ¼', 'ã‚«ãƒ³ã‚°ãƒ¼', 'ãƒ‰ãƒ–ãƒ­', 'ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼']):
        return 8
    else:
        return 5

def get_body_type_bonus(body_type):
    if body_type == 'SUV': return 300000
    if body_type == 'ãƒŸãƒ‹ãƒãƒ³': return 250000
    if body_type == 'ã‚¹ãƒãƒ¼ãƒ„/ã‚¯ãƒ¼ãƒš': return 1000000
    if body_type == 'è»½è‡ªå‹•è»Š': return -400000
    if body_type == 'ã‚»ãƒ€ãƒ³': return 100000
    if body_type == 'ãƒãƒ³/ãƒˆãƒ©ãƒƒã‚¯': return 50000
    return 0 
    
# 5. ä»®æƒ³åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç”Ÿæˆ (ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—åˆ—ã‚’è¿½åŠ )
@st.cache_data
def load_inventory_data():
    data_size = 10000
    np.random.seed(42)
    
    all_makers_models = []
    for country, makers in COUNTRIES_DATA.items():
        for maker, models in makers.items():
            if models == ['ï¼ˆãã®ä»–ï¼‰']:
                 continue
            for model in models:
                all_makers_models.append((country, maker, model))

    indices = np.random.choice(len(all_makers_models), data_size)
    selected_trios = [all_makers_models[i] for i in indices]

    data = {
        'å›½': [trio[0] for trio in selected_trios],
        'ãƒ¡ãƒ¼ã‚«ãƒ¼': [trio[1] for trio in selected_trios],
        'è»Šç¨®': [trio[2] for trio in selected_trios],
        'èµ°è¡Œè·é›¢(km)': np.random.randint(1000, 150000, data_size),
        'å¹´å¼': np.random.randint(2010, 2025, data_size),
        'çŠ¶æ…‹(1-5)': np.random.randint(1, 6, data_size),
    }
    df = pd.DataFrame(data)
    
    df['ä¹—è»Šäººæ•°'] = df['è»Šç¨®'].apply(get_seating_capacity)
    df['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'] = df['è»Šç¨®'].apply(get_body_type) 
    
    df['ä¾¡æ ¼'] = (
        1500000  
        - (df['èµ°è¡Œè·é›¢(km)'] * 8) 
        - ((2025 - df['å¹´å¼']) * 100000)
        + (df['çŠ¶æ…‹(1-5)'] * 30000)
        + df['ãƒ¡ãƒ¼ã‚«ãƒ¼'].apply(get_price_bonus)
        + df['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'].apply(get_body_type_bonus) 
        + np.random.randn(data_size) * 100000
    ).clip(lower=50000)
    
    df['ä¾¡æ ¼(ä¸‡å††)'] = (df['ä¾¡æ ¼'] / 10000).round(0).astype(int)
    
    return df[['ãƒ¡ãƒ¼ã‚«ãƒ¼', 'è»Šç¨®', 'ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—', 'ä¾¡æ ¼(ä¸‡å††)', 'å¹´å¼', 'èµ°è¡Œè·é›¢(km)', 'çŠ¶æ…‹(1-5)', 'ä¹—è»Šäººæ•°', 'å›½']]

# 6. ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ (ä¾¡æ ¼äºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰ç”¨)
try:
    model_pipeline = joblib.load('car_price_predictor_model.joblib')
except FileNotFoundError:
    model_pipeline = None
except Exception as e:
    st.error(f"ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    model_pipeline = None

# 7. ä»®æƒ³åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿
inventory_df = load_inventory_data()

# 8. ã‚¢ãƒ—ãƒªã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
st.set_page_config(layout="wide")
st.title("ğŸš— ä¸­å¤è»Š AI ã‚¢ãƒ—ãƒª")

# 9. â˜… ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (ãƒãƒ£ãƒƒãƒˆæ¤œç´¢ã‚’è¿½åŠ ) â˜…
app_mode = st.sidebar.radio(
    "åˆ©ç”¨ã™ã‚‹æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„",
    ('ä¾¡æ ¼äºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰', 'åœ¨åº«æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰', 'ãƒãƒ£ãƒƒãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰') # â˜… è¿½åŠ 
)

# ==================================================================
#                     ä¾¡æ ¼äºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰
# ==================================================================
if app_mode == 'ä¾¡æ ¼äºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰':
    
    st.markdown("### ğŸ“ˆ ä¾¡æ ¼äºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰")
    st.info("æ¡ä»¶ã‚’æŒ‡å®šã—ã¦ã€AIã«1å°ã®ä¾¡æ ¼ã‚’äºˆæ¸¬ã•ã›ã¾ã™ã€‚")

    st.sidebar.header("âš™ï¸ äºˆæ¸¬æ¡ä»¶ã®å…¥åŠ›")

    # (ä¸­ç•¥ ... ) ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å…¥åŠ›é …ç›® (å¤‰æ›´ãªã—ã€ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤å®šå«ã‚€)
    country_options = list(COUNTRIES_DATA.keys())
    selected_country = st.sidebar.selectbox(
        'å›½', options=country_options, key='pred_country'
    )
    maker_options = list(COUNTRIES_DATA[selected_country].keys())
    maker = st.sidebar.selectbox(
        'ãƒ¡ãƒ¼ã‚«ãƒ¼', options=maker_options, key='pred_maker'
    )
    model_options = COUNTRIES_DATA[selected_country][maker]
    model = st.sidebar.selectbox(
        'è»Šç¨®', options=model_options, key='pred_model'
    )
    body_type = get_body_type(model)
    st.sidebar.text_input("ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ— (è‡ªå‹•åˆ¤å®š)", value=body_type, disabled=True)
    current_year = 2025
    year_options = list(range(2010, current_year + 1)) 
    year = st.sidebar.selectbox(
        'å¹´å¼ (è£½é€ å¹´)', options=sorted(year_options, reverse=True), index=5, key='pred_year' 
    )
    mileage = st.sidebar.number_input(
        'èµ°è¡Œè·é›¢ (km)', min_value=1000, max_value=300000, value=50000, step=1000, key='pred_mileage'
    )
    condition = st.sidebar.slider(
        'å•†å“ã®çŠ¶æ…‹è©•ä¾¡ (1:æ‚ªã„ ~ 5:æœ€é«˜)', min_value=1, max_value=5, value=3, step=1, key='pred_condition'
    )

    st.sidebar.markdown("---")
    run_button = st.sidebar.button(
        'ä¾¡æ ¼ã‚’äºˆæ¸¬ã™ã‚‹', type='primary', use_container_width=True
    )

    # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã®è¡¨ç¤º
    if run_button:
        if model_pipeline is None:
            st.error("ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚train_model.py ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")
            st.stop()
            
        input_data = pd.DataFrame({
            'èµ°è¡Œè·é›¢_km': [mileage], 'å¹´å¼': [year], 'ãƒ¡ãƒ¼ã‚«ãƒ¼': [maker], 
            'è»Šç¨®': [model], 'ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—': [body_type], 'çŠ¶æ…‹_è©•ä¾¡': [condition], 
        })
        
        try:
            # (A) äºˆæ¸¬
            predicted_price = model_pipeline.predict(input_data)[0]
            
            # (E) ä¾¡æ ¼å†…è¨³
            price_base = 1500000 
            price_year = -((2025 - year) * 100000)
            price_condition = condition * 30000
            price_mileage = -(mileage * 8)
            price_brand = get_price_bonus(maker)
            price_body = get_body_type_bonus(body_type) 
            price_other = predicted_price - (price_base + price_year + price_condition + price_mileage + price_brand + price_body)
            price_other = max(price_other, -500000) 

            # (F) å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»®æƒ³ï¼‰
            np.random.seed(sum(ord(c) for c in model)) 
            trend_data = np.cumprod(1.0 + (np.random.randn(12) / 10))
            base_price_trend = predicted_price * (0.9 + (np.random.rand() * 0.2))
            final_trend = trend_data * base_price_trend
            chart_data = pd.DataFrame(final_trend, columns=["ä»®æƒ³ä¾¡æ ¼ (å††)"], index=[f"{i}ãƒ¶æœˆå‰" for i in range(11, -1, -1)])
            chart_data.index.name = "æ™‚æœŸ"

            # --- ã‚¿ãƒ–è¡¨ç¤º ---
            tab1, tab2, tab3, tab4 = st.tabs([
                "ğŸ“ˆ äºˆæ¸¬ä¾¡æ ¼ã¨å†…è¨³", "ğŸ‘¥ é–¢é€£ã™ã‚‹æ¨è–¦", "ğŸ“Š AIã®äºˆæ¸¬æ ¹æ‹  (SHAP)", "ğŸ’¹ å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»®æƒ³ï¼‰" 
            ])
            
            # ã‚¿ãƒ– 1: äºˆæ¸¬ä¾¡æ ¼ & å†…è¨³
            with tab1:
                st.subheader("âœ… äºˆæ¸¬ä¾¡æ ¼")
                round_digits = -5 if predicted_price > 10000000 else -3
                formatted_price = f"Â¥{int(round(predicted_price, round_digits)):,}" 
                st.metric(label="äºˆæ¸¬ã•ã‚Œã‚‹è²©å£²ä¾¡æ ¼", value=formatted_price)
                
                st.markdown("---")
                st.subheader("ğŸ’° ä¾¡æ ¼å†…è¨³ã®æ¨å®šï¼ˆä»®æƒ³ï¼‰")
                col1, col2, col3 = st.columns(3)
                physical_value = price_year + price_condition + price_mileage
                col1.metric("å¹´å¼/èµ°è¡Œ/çŠ¶æ…‹", f"Â¥{int(physical_value):,}", help=f"å¹´å¼: {price_year:,}å†† / çŠ¶æ…‹: {price_condition:,}å†† / èµ°è¡Œ: {price_mileage:,}å††")
                col2.metric("ãƒ–ãƒ©ãƒ³ãƒ‰ä¾¡å€¤", f"Â¥{int(price_brand):,}")
                col3.metric("è»Šç¨®/ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—äººæ°—", f"Â¥{int(price_body + price_other):,}", help=f"ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—: {price_body:,}å†† / ãã®ä»–: {price_other:,}å††")
                st.caption(f"â€» åŸºæœ¬ä¾¡æ ¼ (Â¥{price_base:,}) ã«å¯¾ã™ã‚‹å¢—æ¸›ã®ç›®å®‰ã§ã™ã€‚")

            # ã‚¿ãƒ– 2: æ¨è–¦
            with tab2:
                st.subheader("ğŸ‘¥ é–¢é€£ãƒ¡ãƒ¼ã‚«ãƒ¼æ¨è–¦ (å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)")
                target_maker = maker
                if target_maker in interest_df.columns:
                    correlations = interest_df.corrwith(interest_df[target_maker]).sort_values(ascending=False)
                    recommendations = correlations.drop(target_maker, errors='ignore').dropna().drop('ãã®ä»–', errors='ignore')
                    top_recommendations = recommendations.head(3)
                    
                    if top_recommendations.empty or top_recommendations.max() < 0.1:
                        st.info(f"**{target_maker}** ã«é–¢ã™ã‚‹æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚")
                    else:
                        st.info(f"**{target_maker}** ã«èˆˆå‘³ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ä»¥ä¸‹ã®ãƒ¡ãƒ¼ã‚«ãƒ¼ã«ã‚‚é–¢å¿ƒã‚’æŒã£ã¦ã„ã¾ã™ã€‚")
                        rec_list = []
                        for rank, (rec_maker_jp, score) in enumerate(top_recommendations.items(), 1):
                            if score > 0.8: intensity = "éå¸¸ã«å¼·ã„é–¢å¿ƒ"
                            elif score > 0.4: intensity = "å¼·ã„é–¢å¿ƒ"
                            elif score > 0: intensity = "ä¸€èˆ¬çš„ãªé–¢å¿ƒ"
                            else: continue 
                            rec_list.append(f"{rank}. **{rec_maker_jp}** (é–¢å¿ƒåº¦: {score:.2f} - {intensity})")
                        st.markdown('\n'.join(rec_list))
                else:
                    st.warning(f"**{target_maker}** ã®æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚")

            # ã‚¿ãƒ– 3: AIã®äºˆæ¸¬æ ¹æ‹  (SHAP)
            with tab3:
                st.subheader("ğŸ“Š AIã«ã‚ˆã‚‹ã€Œã“ã®1å°ã€ã®ä¾¡æ ¼åˆ†æ")
                try:
                    with st.spinner("AIãŒäºˆæ¸¬ã®æ ¹æ‹ ã‚’åˆ†æä¸­ã§ã™..."):
                        preprocessor = model_pipeline.named_steps['preprocessor']
                        model_regressor = model_pipeline.named_steps['regressor']
                        input_transformed = preprocessor.transform(input_data)
                        explainer = shap.TreeExplainer(model_regressor)
                        shap_values = explainer.shap_values(input_transformed)
                        
                        num_features = [col for col in input_data.columns if col not in ['ãƒ¡ãƒ¼ã‚«ãƒ¼', 'è»Šç¨®', 'ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—']]
                        cat_features = preprocessor.named_transformers_['cat'].get_feature_names_out(['ãƒ¡ãƒ¼ã‚«ãƒ¼', 'è»Šç¨®', 'ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'])
                        feature_names = list(cat_features) + num_features
                        
                        st.info("ã“ã®ã‚°ãƒ©ãƒ•ã¯ã€AIã®äºˆæ¸¬ä¾¡æ ¼ï¼ˆèµ¤ï¼‰ãŒã€ã©ã®è¦å› ï¼ˆç‰¹å¾´é‡ï¼‰ã«ã‚ˆã£ã¦åŸºæº–å€¤ï¼ˆbase valueï¼‰ã‹ã‚‰æŠ¼ã—ä¸Šã’ã‚‰ã‚ŒãŸï¼ˆèµ¤ï¼‰/æŠ¼ã—ä¸‹ã’ã‚‰ã‚ŒãŸï¼ˆé’ï¼‰ã‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚")
                        
                        fig, ax = plt.subplots()
                        shap.force_plot(explainer.expected_value, shap_values[0,:], feature_names, matplotlib=True, show=False, ax=ax)
                        st.pyplot(fig, use_container_width=True)

                        st.markdown("---")
                        st.subheader("ğŸ” SHAP Waterfall ãƒ—ãƒ­ãƒƒãƒˆ")
                        st.info("ä¸Šã®ã‚°ãƒ©ãƒ•ã‚’ã€ã‚ˆã‚Šè©³ç´°ãªã€Œã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ï¼ˆæ»ï¼‰ãƒãƒ£ãƒ¼ãƒˆã€ã§è¡¨ç¤ºã—ã¾ã™ã€‚")
                        
                        shap_exp = shap.Explanation(
                            values=shap_values[0],
                            base_values=explainer.expected_value,
                            data=input_transformed[0],
                            feature_names=feature_names
                        )
                        
                        fig_waterfall, ax_waterfall = plt.subplots()
                        shap.waterfall_plot(shap_exp, max_display=10, show=False)
                        st.pyplot(fig_waterfall)
                except Exception as e:
                    st.error(f"SHAPåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

            # ã‚¿ãƒ– 4: å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰
            with tab4:
                st.subheader(f"ğŸ’¹ {model} ã®ä¾¡æ ¼ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»®æƒ³ï¼‰")
                st.info("ã“ã‚Œã¯ãƒ‡ãƒ¢ç”¨ã®ä»®æƒ³ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚Šã€å®Ÿéš›ã®å¸‚å ´ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚")
                st.line_chart(chart_data)

        except Exception as e:
            st.error(f"äºˆæ¸¬ã¾ãŸã¯æ¨è–¦å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: {e}")

    else:
        st.info("ğŸ‘ˆ å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§æ¡ä»¶ã‚’å…¥åŠ›ã—ã€ã€Œä¾¡æ ¼ã‚’äºˆæ¸¬ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")

# ==================================================================
#                     åœ¨åº«æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰
# ==================================================================
elif app_mode == 'åœ¨åº«æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰':
    
    st.markdown("### ğŸ” åœ¨åº«æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰")
    st.info(f"ä»®æƒ³ã®åœ¨åº«ï¼ˆå…¨{len(inventory_df):,}å°ï¼‰ã‹ã‚‰ã€å¸Œæœ›ã®æ¡ä»¶ã«åˆã†è»Šã‚’æ¤œç´¢ã—ã¾ã™ã€‚")
    
    st.sidebar.header("ğŸ”‘ å¸Œæœ›æ¡ä»¶ã®å…¥åŠ›")
    
    # (ä¸­ç•¥ ... ) ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ¤œç´¢æ¡ä»¶ (ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—æ¤œç´¢å«ã‚€)
    min_price_db = int(inventory_df['ä¾¡æ ¼(ä¸‡å††)'].min())
    max_price_db = int(inventory_df['ä¾¡æ ¼(ä¸‡å††)'].max())
    budget = st.sidebar.slider(
        'äºˆç®— (ä¸‡å††)', min_value=min_price_db, max_value=max_price_db, value=(min_price_db, max_price_db), step=10, key='search_budget'
    )
    is_budget_specified = (budget[0] != min_price_db) or (budget[1] != max_price_db)
    search_country_options = ['æŒ‡å®šãªã—'] + list(COUNTRIES_DATA.keys())
    search_selected_country = st.sidebar.selectbox(
        'å›½ (ä»»æ„)', options=search_country_options, key='search_country'
    )
    if search_selected_country != 'æŒ‡å®šãªã—':
        search_maker_options = ['æŒ‡å®šãªã—'] + list(COUNTRIES_DATA[search_selected_country].keys())
    else:
        search_maker_options = ['æŒ‡å®šãªã—']
    search_maker = st.sidebar.selectbox(
        'ãƒ¡ãƒ¼ã‚«ãƒ¼ (ä»»æ„)', options=search_maker_options, key='search_maker'
    )
    if search_selected_country != 'æŒ‡å®šãªã—' and search_maker != 'æŒ‡å®šãªã—':
        search_model_options = ['æŒ‡å®šãªã—'] + COUNTRIES_DATA[search_selected_country][search_maker]
    else:
        search_model_options = ['æŒ‡å®šãªã—']
    search_model = st.sidebar.selectbox(
        'è»Šç¨® (ä»»æ„)', options=search_model_options, key='search_model'
    )
    st.sidebar.markdown("---")
    body_type_options = ['æŒ‡å®šãªã—'] + sorted(list(inventory_df['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'].unique()))
    search_body_type = st.sidebar.selectbox(
        'ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ— (ä»»æ„)', options=body_type_options, key='search_body_type'
    )
    max_mileage = st.sidebar.slider(
        'èµ°è¡Œè·é›¢ (kmä»¥ä¸‹)', min_value=10000, max_value=150000, value=150000, step=1000, key='search_mileage'
    )
    is_mileage_specified = (max_mileage != 150000)
    min_year = st.sidebar.slider(
        'å¹´å¼ (å¹´ä»¥é™)', min_value=2010, max_value=2025, value=2010, step=1, key='search_year'
    )
    is_year_specified = (min_year != 2010)
    min_condition = st.sidebar.slider(
        'çŠ¶æ…‹è©•ä¾¡ (â˜… ä»¥ä¸Š)', min_value=1, max_value=5, value=1, step=1, key='search_condition'
    )
    is_condition_specified = (min_condition != 1)
    min_seating = st.sidebar.slider(
        'ä¹—è»Šäººæ•° (äººä»¥ä¸Š)', min_value=2, max_value=8, value=2, step=1, key='search_seating'
    )
    is_seating_specified = (min_seating != 2)
    st.sidebar.markdown("---")
    
    search_button = st.button("ã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹", type='primary')
    
    if 'search_results' not in st.session_state:
        st.session_state.search_results = pd.DataFrame()
    if 'search_clicked' not in st.session_state:
        st.session_state.search_clicked = False

    def run_search():
        filtered_df = inventory_df.copy()
        if is_budget_specified:
            filtered_df = filtered_df[
                (filtered_df['ä¾¡æ ¼(ä¸‡å††)'] >= budget[0]) & 
                (filtered_df['ä¾¡æ ¼(ä¸‡å††)'] <= budget[1])
            ]
        if search_maker != 'æŒ‡å®šãªã—':
            filtered_df = filtered_df[filtered_df['ãƒ¡ãƒ¼ã‚«ãƒ¼'] == search_maker]
        if search_model != 'æŒ‡å®šãªã—':
            filtered_df = filtered_df[filtered_df['è»Šç¨®'] == search_model]
        if search_body_type != 'æŒ‡å®šãªã—':
            filtered_df = filtered_df[filtered_df['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'] == search_body_type]
        if is_mileage_specified:
            filtered_df = filtered_df[filtered_df['èµ°è¡Œè·é›¢(km)'] <= max_mileage]
        if is_year_specified:
            filtered_df = filtered_df[filtered_df['å¹´å¼'] >= min_year]
        if is_condition_specified:
            filtered_df = filtered_df[filtered_df['çŠ¶æ…‹(1-5)'] >= min_condition]
        if is_seating_specified:
            filtered_df = filtered_df[filtered_df['ä¹—è»Šäººæ•°'] >= min_seating]
        
        st.session_state.search_results = filtered_df
        st.session_state.search_clicked = True

    if search_button:
        run_search()

    search_results_df = st.session_state.search_results
    
    if st.session_state.search_clicked: 
        if not search_results_df.empty:
            st.subheader(f"æ¤œç´¢çµæœ: {len(search_results_df):,} ä»¶")

            if len(search_results_df) > 10:
                st.success("å¤šæ•°ã®è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ©ãƒ³ãƒ€ãƒ ã«10ä»¶è¡¨ç¤ºã—ã¾ã™ã€‚")
                display_df = search_results_df.sample(10).sort_values('ä¾¡æ ¼(ä¸‡å††)')
            else:
                st.success(f"{len(search_results_df)}ä»¶ã®è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚")
                display_df = search_results_df.sort_values('ä¾¡æ ¼(ä¸‡å††)')

            # --- â˜… ã‚«ãƒ¼ãƒ‰è¡¨ç¤º (ç”»åƒæ¬„ãªã—) ---
            for _, row in display_df.iterrows():
                st.markdown("---") 
                st.subheader(f"{row['ãƒ¡ãƒ¼ã‚«ãƒ¼']} {row['è»Šç¨®']}")
                st.metric(label="ä¾¡æ ¼", value=f"{row['ä¾¡æ ¼(ä¸‡å††)']:,} ä¸‡å††")
                stars = "â˜…" * row['çŠ¶æ…‹(1-5)'] + "â˜†" * (5 - row['çŠ¶æ…‹(1-5)'])
                st.markdown(f"**{row['å¹´å¼']}å¹´å¼** | **{row['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—']}** | **{row['ä¹—è»Šäººæ•°']}äºº** ä¹—ã‚Š")
                st.markdown(f"èµ°è¡Œ **{row['èµ°è¡Œè·é›¢(km)']: >7,} km** | çŠ¶æ…‹ **{stars}**")

            st.markdown("---")
            
            if len(search_results_df) > 10:
                if st.button("å†æ¤œç´¢ï¼ˆåˆ¥ã®å€™è£œã‚’è¦‹ã‚‹ï¼‰"):
                    st.rerun()

        else: 
            st.warning("å¸Œæœ›ã®æ¡ä»¶ã«åˆã†è»Šã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚")

    else: 
        st.info("ğŸ‘ˆ å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§å¸Œæœ›ã®æ¡ä»¶ã‚’å…¥åŠ›ã—ã€ã€Œã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")

# ==================================================================
#                     â˜… æ–°æ©Ÿèƒ½ï¼šãƒãƒ£ãƒƒãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ â˜…
# ==================================================================
elif app_mode == 'ãƒãƒ£ãƒƒãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰':
    
    st.markdown("### ğŸ’¬ ãƒãƒ£ãƒƒãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰")
    st.info("ã€Œ100ä¸‡å††ä»¥ä¸‹ã§è·ç‰©ãŒç©ã‚ã‚‹ãƒŸãƒ‹ãƒãƒ³ã€ã®ã‚ˆã†ã«ã€ãƒãƒ£ãƒƒãƒˆã§å¸Œæœ›ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚AIãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã€åœ¨åº«ã‚’æ¤œç´¢ã—ã¾ã™ã€‚")

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åˆæœŸåŒ–
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # å±¥æ­´ã‚’è¡¨ç¤º
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã¤
    if prompt := st.chat_input("ã”å¸Œæœ›ã®æ¡ä»¶ã‚’ã©ã†ãï¼ˆä¾‹ï¼šå®‰ãã¦æ–°ã—ã„è»½è‡ªå‹•è»Šï¼‰"):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ ã—ã¦è¡¨ç¤º
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # AIã®å¿œç­”ï¼ˆæ¤œç´¢å‡¦ç†ï¼‰
        with st.chat_message("assistant"):
            with st.spinner("ã”å¸Œæœ›ã«åˆã†è»Šã‚’åœ¨åº«ã‹ã‚‰æ¢ã—ã¦ã„ã¾ã™..."):
                # --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ ---
                filtered_df = inventory_df.copy()
                
                # 1. ä¾¡æ ¼ã®æŠ½å‡º (ä¾‹: "100ä¸‡", "200ä¸‡")
                price_matches = re.findall(r'(\d+)ä¸‡', prompt)
                if price_matches:
                    try:
                        # è¦‹ã¤ã‹ã£ãŸæœ€åˆã®æ•°å­—ã‚’äºˆç®—ä¸Šé™ã¨ã™ã‚‹
                        max_budget = int(price_matches[0])
                        filtered_df = filtered_df[filtered_df['ä¾¡æ ¼(ä¸‡å††)'] <= max_budget]
                        st.write(f"ï¼ˆAIãƒ¡ãƒ¢ï¼šäºˆç®— {max_budget}ä¸‡å††ä»¥ä¸‹ ã§æ¤œç´¢ã—ã¾ã™ï¼‰")
                    except ValueError:
                        pass # æ•°å­—å¤‰æ›å¤±æ•—ã¯ç„¡è¦–

                # 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ãƒ¡ãƒ¼ã‚«ãƒ¼, è»Šç¨®, ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—)
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å°æ–‡å­—åŒ–ãƒ»æ­£è¦åŒ–
                search_term = prompt.lower().strip()
                
                # æ¤œç´¢å¯¾è±¡ã®åˆ—ã‚’æ–‡å­—åˆ—ã¨ã—ã¦çµåˆ
                # ï¼ˆä¾‹: "ãƒˆãƒ¨ã‚¿ ãƒ—ãƒªã‚¦ã‚¹ ã‚»ãƒ€ãƒ³"ï¼‰
                # å¤§æ–‡å­—/å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¦æ¤œç´¢
                search_mask = inventory_df.apply(
                    lambda row: (
                        row['ãƒ¡ãƒ¼ã‚«ãƒ¼'].lower() in search_term or 
                        row['è»Šç¨®'].lower().split('(')[0].strip() in search_term or 
                        row['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'].lower() in search_term
                    ),
                    axis=1
                )
                
                # ã€Œè·ç‰©ã€ã€Œç©ã‚ã‚‹ã€ -> ãƒãƒ³/ãƒŸãƒ‹ãƒãƒ³
                if "è·ç‰©" in search_term or "ç©ã‚ã‚‹" in search_term:
                    search_mask = search_mask | inventory_df['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—'].isin(['ãƒŸãƒ‹ãƒãƒ³', 'ãƒãƒ³/ãƒˆãƒ©ãƒƒã‚¯', 'ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ã‚´ãƒ³']) # ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ã‚´ãƒ³ã¯æœªå®šç¾©ã ãŒä¾‹ã¨ã—ã¦
                    st.write("ï¼ˆAIãƒ¡ãƒ¢ï¼šã€è·ç‰©ãŒç©ã‚ã‚‹ã€ã¨è§£é‡ˆã—ã€ãƒŸãƒ‹ãƒãƒ³ç­‰ã‚‚æ¤œç´¢ã—ã¾ã™ï¼‰")

                # ã€Œæ–°ã—ã„ã€ã€Œæ–°è»Šã€ -> 2022å¹´ä»¥é™
                if "æ–°ã—ã„" in search_term or "æ–°è»Š" in search_term:
                    filtered_df = filtered_df[filtered_df['å¹´å¼'] >= 2022]
                    st.write("ï¼ˆAIãƒ¡ãƒ¢ï¼šã€æ–°ã—ã„ã€ã¨è§£é‡ˆã—ã€2022å¹´å¼ä»¥é™ã§æ¤œç´¢ã—ã¾ã™ï¼‰")

                # ã€Œå®‰ã„ã€ã€Œæ ¼å®‰ã€ -> 50ä¸‡å††ä»¥ä¸‹
                if "å®‰ã„" in search_term or "æ ¼å®‰" in search_term:
                    filtered_df = filtered_df[filtered_df['ä¾¡æ ¼(ä¸‡å††)'] <= 50]
                    st.write("ï¼ˆAIãƒ¡ãƒ¢ï¼šã€å®‰ã„ã€ã¨è§£é‡ˆã—ã€50ä¸‡å††ä»¥ä¸‹ã§æ¤œç´¢ã—ã¾ã™ï¼‰")


                if search_mask.any():
                    filtered_df = filtered_df[search_mask]
                
                # --- æ¤œç´¢çµæœã®è¡¨ç¤º ---
                if len(filtered_df) == 0:
                    response = "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã”å¸Œæœ›ã®æ¡ä»¶ã«åˆã†è»Šã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
                    st.warning(response)
                
                elif len(filtered_df) > 10:
                    response = f"å¤šæ•°ï¼ˆ{len(filtered_df)}ä»¶ï¼‰ã®è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ©ãƒ³ãƒ€ãƒ ã«10ä»¶ã”ç´¹ä»‹ã—ã¾ã™ã€‚"
                    st.success(response)
                    display_df = filtered_df.sample(10).sort_values('ä¾¡æ ¼(ä¸‡å††)')
                
                else: # 1ã€œ10ä»¶
                    response = f"{len(filtered_df)}ä»¶ã®è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã¡ã‚‰ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ"
                    st.success(response)
                    display_df = filtered_df.sort_values('ä¾¡æ ¼(ä¸‡å††)')

                # ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤º
                if not filtered_df.empty:
                    for _, row in display_df.iterrows():
                        st.markdown("---") 
                        st.subheader(f"{row['ãƒ¡ãƒ¼ã‚«ãƒ¼']} {row['è»Šç¨®']}")
                        st.metric(label="ä¾¡æ ¼", value=f"{row['ä¾¡æ ¼(ä¸‡å††)']:,} ä¸‡å††")
                        stars = "â˜…" * row['çŠ¶æ…‹(1-5)'] + "â˜†" * (5 - row['çŠ¶æ…‹(1-5)'])
                        st.markdown(f"**{row['å¹´å¼']}å¹´å¼** | **{row['ãƒœãƒ‡ã‚£ã‚¿ã‚¤ãƒ—']}** | **{row['ä¹—è»Šäººæ•°']}äºº** ä¹—ã‚Š")
                        st.markdown(f"èµ°è¡Œ **{row['èµ°è¡Œè·é›¢(km)']: >7,} km** | çŠ¶æ…‹ **{stars}**")
                    st.markdown("---")
                    response += "\nï¼ˆã‚«ãƒ¼ãƒ‰ã§10ä»¶è¡¨ç¤ºã—ã¾ã—ãŸï¼‰" # å±¥æ­´ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆ

            # AIã®å¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ 
            st.session_state.messages.append({"role": "assistant", "content": response})